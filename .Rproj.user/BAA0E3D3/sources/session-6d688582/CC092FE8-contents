#' @name choropleth
#' @export



# creates choropleth maps quickly
# returns a choropleth map of a single variable
choropleth <- function(data, col, pal=default_pal_discrete,
                       show_legend=FALSE, title = NULL,
                       legend_lab = "Legend",
                       legend_pct=FALSE,
                       type="discrete",
                       caption=NULL,
                       label=NA,
                       label_size=5,
                       axis_text_size=default_axis_text_size,
                       line_width=default_graph_linewidth) {
  # retrieve settings
  source("R/settings.R")
  midpoint <- mean(data[[col]])

  if(type=="discrete") {
    # base case discrete categories

    graph <- ggplot2::ggplot(data,mapping=aes(fill=.data[[col]])) +
      # add basic aesthetic settings
      ggplot2::scale_fill_manual(values=pal,name=legend_lab,drop=FALSE) +
      ggplot2::theme_minimal() +
      ggplot2::labs(title=title,caption=caption)  +
      ggplot2::theme(axis.text = element_blank(),
            legend.background = element_rect(fill = "transparent", color = NA),
            panel.grid = element_blank(),
            legend.text = element_text(size=axis_text_size*0.5),
            legend.title = element_text(size=axis_text_size,face="bold"),
            plot.caption = element_text(size=0.6*axis_text_size,face="italic",
                                        hjust=0.5),
            strip.text = element_text(size=axis_text_size,face="bold"),
            strip.background = element_blank()) +
      ggplot2::geom_sf(linewidth=line_width/1.5,color="white",show.legend = show_legend)

    # alt case where we want continuous variables
    } else if(type=="gradient") {
    graph <- ggplot2::ggplot(data,mapping=aes(fill=.data[[col]])) +
      ggplot2::scale_fill_gradient2(high=pal[5],
                           mid=pal[3],
                           low=pal[1],name=legend_lab,
                           midpoint=midpoint,
                           labels=scales::comma,
                           breaks=c(min(data[[col]]),
                                    0,
                                    midpoint,
                                    max(data[[col]]))) +
      #guides(fill=guide_legend(ncol=1)) +
      # add basic aesthetic settings
      ggplot2::theme_minimal() +
      ggplot2::labs(title=title,caption=caption)  +
      ggplot2::theme(axis.text = element_blank(),
            panel.grid = element_blank(),
            legend.background = element_rect(fill = "transparent", color = NA),
            legend.text = element_text(size=axis_text_size*0.5),
            legend.title = element_text(size=axis_text_size,face="bold"),
            plot.caption = element_text(size=0.6*axis_text_size,face="italic",
                                        hjust=0.5),
            strip.text = element_text(size=axis_text_size,face="bold"),
            strip.background = element_blank()) +
      ggplot2::geom_sf(linewidth=line_width/1.5,color="white",show.legend = show_legend)

    # add percent marker to legend if requested
    if (legend_pct == TRUE) {
      graph <- graph +
        ggplot2::scale_fill_gradient2(high=pal[5],
                             mid=pal[3],
                             low=pal[1],name=legend_lab,
                             midpoint=midpoint,
                             labels=percent_marker,
                             breaks=c(min(data[[col]]),
                                      0,
                                      midpoint,
                                      max(data[[col]])))
      # limits=c(floor(min(data[[col]])/10)*10,
      #          ceiling(max(data[[col]])/10)*10))
    }
  } else {
    print("Invalid graph type")
  }
  # remove legend if specified
  if(show_legend == FALSE) {
    graph <- graph +
      ggplot2::theme(legend.position = "none")
  }

  # add labels if specified
  if(!is.na(label)) {
    graph <- graph +
      ggplot2::geom_sf_text(aes(label=.data[[label]]),size=label_size,fontface="bold") +
      ggplot2::labs(x="",y="")
  }
  # return output
  graph
}

#' @name join_geometries
#' @export
#'
#'

# function to automatically join the relevant geometries to data from tigris

join_geometries <- function(data,
                            field="GEOID", # field to reference, should be a FIPS code unless findfips_cty = TRUE
                            geo_level = "county", # options: county, tract
                            findfips_cty = FALSE # set to true if field is a list of county names instead of FIPS. Should include states if multi state
) {
  # find fips if specified
  if(findfips_cty == TRUE) {
    ctys <- data %>%
      dplyr::pull(field)
    data <- data %>%
      dplyr::mutate(GEOID = get_fips(ctys))
    field <- "GEOID"
  }

  # retrieve geometry based on geo level
  if (tolower(geo_level)=="county") {
    geo <- us_counties() %>%
      dplyr::select(GEOID) %>%
      dplyr::rename("joinfield"=GEOID) %>%
      dplyr::mutate(joinfield=as.character(joinfield))
  } else if (tolower(geo_level) == "tract") {
    geo <- us_tracts() %>%
      dplyr::select(GEOID) %>%
      dplyr::rename("joinfield"=GEOID) %>%
      dplyr::mutate(joinfield=as.character(joinfield))
  } else {
    print("Failed to join. Unrecognized geo level. Choose from: county, tract")
  }

  output <- data %>%
    # rename joinfield to generic name
    dplyr::rename("joinfield"=sym(field)) %>%
    dplyr::mutate(joinfield=as.character(joinfield)) %>%
    dplyr::left_join(geo) %>%
    #dplyr::select(-joinfield) %>%
    sf::st_as_sf()

  # reset colnames
  colnames(output) <- c(colnames(data),"geometry")

  print("Joined geometries.")
  output
}

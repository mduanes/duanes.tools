#' @name equal_interval
#' @export


# classifies data using equal interval method

equal_interval <- function(data,
                           field, # field to classify
                           n, # number of classes
                           forcezero=FALSE, # force zero if both positive and negative numbers
                           class_name="classified" # name of output classified factor field
                           ) {

  options(scipen = 999)

 # pull values of field to be classified
  field_fun <- data %>%
    pull(field) %>%
    as.numeric()

  # find step size of equal interval
  step_size <- (max(field_fun,na.rm = TRUE) - min(field_fun,na.rm = TRUE))/n

  # round down to "magnitude" (e.g. highest number of zeros) of field to make intervals clean
  magnitude <- as.numeric(paste0(1,paste0(rep(0,nchar(round(step_size))-1),collapse="")))
  classes <- seq(plyr::round_any(min(field_fun,na.rm = TRUE),magnitude,floor),
                 plyr::round_any(max(field_fun,na.rm = TRUE),magnitude,ceiling),
                 (plyr::round_any(max(field_fun,na.rm = TRUE),magnitude,ceiling)- plyr::round_any(min(field_fun,na.rm = TRUE),magnitude,ceiling))/n) %>%
    unique()

  # insert 0 if relevant
    if(forcezero==TRUE) {
    for(i in 1:length(classes)) {
      if(classes[i] < 0 & classes[i+1] >= 0) {
        classes <- c(classes[1:i],0,classes[i+1:length(classes)])
      }
    }
    }

  # classify field
  for(i in 1:n) {
    # for first level
    if (i == 1) {
      # create label
      class_lab <- paste0(format(classes[i],big.mark=","), " - ", format(classes[i+1],big.mark=","))
      # set order
      order <- class_lab
      # classify
      data_out <- data %>%
        # rename classify field to generic name
        rename("field_class"=sym(field)) %>%
        # classify
        mutate(classified=case_when(field_class >= classes[i] & field_class < classes[i+1]~class_lab,
                                    TRUE~NA))
      # intermediate levels
    } else if (i != n) {
      # create class label
      class_lab <- paste0(format(classes[i],big.mark=","), " - ", format(classes[i+1],big.mark=","))
      # set order
      order <- c(order,class_lab)
      # classify
      data_out <- data_out %>%
        mutate(classified=case_when(field_class >= classes[i] & field_class < classes[i+1]~class_lab,
                                    TRUE~classified))
    } else {
      # create label
      class_lab <- paste0(format(classes[i],big.mark=","), " + ")
      # set order
      order <- c(order,class_lab)
      # classify
      data_out <- data_out %>%
        mutate(classified=case_when(field_class >= classes[i]~class_lab,
                                    TRUE~classified))
    }
  }

  # order classes based on order vector
  data_out <- data_out %>%
    mutate(classified=factor(classified,order))

  # rename class output field and input field to original name
  colnames(data_out) <- c(colnames(data),class_name)

  # return output data
  data_out
}

